#!/bin/bash

cutoff_time=$(($(date -d '+6 hours' +%s) - $(date +%s) + 1))
filename=~/logs/statsbot-log-$(date +%F)

rm -rf statsbot
wget https://ci.appveyor.com/api/projects/phantomical/airmash-logs/artifacts/statsbot.min.js.gz?branch=master -O statsbot.min.js.gz
gunzip statsbot.min.js.gz -o statsbot.min.js

circleci_token=1ce24f41ffca398bd57b9115c0e77d6290b5553d
build_num=$(wget -q "https://circleci.com/api/v1.1/project/github/phantomical/airmash-logs?circle-token=$circleci_token&filter=successful" -O - | jq '[.[] | select(.build_parameters.CIRCLE_JOB=="deploy")][0].build_num')
path=$(wget -q "https://circleci.com/api/v1.1/project/github/phantomical/airmash-logs/$build_num/artifacts?circle-token=$circleci_token&branch=master&filter=successful" -O - | jq -r '.[0].url')
wget -q $path -O statsbot.tar.gz

timeout $cutoff_time node statsbot.min.js | tee -a ~/statsbot-log-complete > ~/statsbot-log 2>> ~/statsbot-errlog

exitval=$?

#update bot
ctr=0
while [ -e $filename-$ctr.gz ]; do
	((ctr++))
done

if [ -s ~/statsbot-log ]; then
	./../stats-lib/anonymise.py ~/statsbot-log | gzip > $filename-$ctr.gz
fi

rm ~/logs/stats-lib.tar.gz
tar czf ~/logs/stats-lib.tar.gz ~/airmash-logs/stats-lib

git pull

sleep 5

if [ $exitval -ne 56 ]; then
	# Restart the script with the updated one
	exec "$(which $0)"
fi
