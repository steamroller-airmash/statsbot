#!/bin/bash

time_to_midnight=$(($(date -d 'tomorrow 08:00:00' +%s) - $(date +%s) + 1))
filename=~/logs/statsbot-log-$(date +%F)

rm -f statsbot.min.js
wget https://ci.appveyor.com/api/projects/phantomical/airmash-logs/artifacts/statsbot/statsbot.min.js?branch=master -O statsbot.min.js

timeout $time_to_midnight node statsbot.min.js | tee -a ~/statsbot-log-complete > ~/statsbot-log 2>> ~/statsbot-errlog

exitval=$?

#update bot
ctr=0
while [ -e $filename-$ctr.gz ]; do
	((ctr++))
done

if [ -s ~/statsbot-log ]; then
	python3 ../stats-lib/anonymize.py ~/statsbot-log | gzip > $filename-$ctr.gz
fi

rm ~/logs/stats-lib.tar.gz
tar czf ~/logs/stats-lib.tar.gz ~/airmash-logs/stats-lib

git pull

sleep 5

if [ $exitval -ne 56 ]; then
	# Restart the script with the updated one
	exec "$(which $0)"
fi
